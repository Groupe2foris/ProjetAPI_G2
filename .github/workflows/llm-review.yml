name: LLM Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [ develop ]

jobs:
  review_and_notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt update && sudo apt install jq -y
      
      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Call LLM API
        id: llm
        run: |
          RESPONSE=$(curl -s -X POST "https://api.gemini.com/v1/messages" \
            -H "Authorization: Bearer ${{ secrets.GEMINI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "messages": [
                {
                  "role": "user",
                  "content": "Tu es un relecteur de code expert. Analyse ce diff et fournis des pistes d'\''amélioration ou liste les bugs trouvés. Réponds en français.\n\n${{ steps.diff.outputs.diff }}"
                }
              ]
            }')
          REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // .candidates[0].content.parts[0].text // .content // $RESPONSE')
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**Revue LLM** @${{ github.actor }}\n\n${{ steps.llm.outputs.review }}'
            })
      
      - name: Send Personalized Emails
        run: |
          IFS=',' read -r -a emails <<< "${{ secrets.TEAM_EMAIL_LIST }}"
          declare -A interests
          IFS=',' read -r -a pairs <<< "${{ secrets.INTERESTS_MAP }}"
          for pair in "${pairs[@]}"; do
            key="${pair%%:*}"
            value="${pair#*:}"
            interests["$key"]="$value"
          done
          SUBJECT="Revue LLM pour PR #${{ github.event.pull_request.number }} par @${{ github.actor }}"
          FROM="${{ secrets.MAIL_FROM }}"
          USER="${{ secrets.MAIL_USERNAME }}"
          PASS="${{ secrets.MAIL_PASSWORD }}"
          SERVER="smtp.gmail.com"
          PORT="465"
          REVIEW="${{ steps.llm.outputs.review }}"
          for to in "${emails[@]}"; do
            interest="${interests[$to]:-programmation}"
            MOTIV_PROMPT="Génère un court paragraphe (3-4 phrases maximum) pour une introduction d'\''e-mail. Utilise une ANALOGIE tirée de '\''$interest'\'' pour motiver l'\''utilisateur à corriger le code et à réussir. Réponds en français."
            MOTIV_RESP=$(curl -s -X POST "https://api.gemini.com/v1/messages" \
              -H "Authorization: Bearer ${{ secrets.GEMINI_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d '{
                "messages": [
                  {
                    "role": "user",
                    "content": "'"$MOTIV_PROMPT"'"
                  }
                ]
              }')
            MOTIV=$(echo "$MOTIV_RESP" | jq -r '.choices[0].message.content // .candidates[0].content.parts[0].text // .content // $MOTIV_RESP')
            BODY="Motivation\n\n$MOTIV\n\nVoici la revue générée par l'IA :\n\n$REVIEW"
            curl --url "smtps://$SERVER:$PORT" --ssl-reqd \
              --mail-from "$FROM" --mail-rcpt "$to" \
              --user "$USER:$PASS" \
              -T <(echo -e "From: $FROM\nTo: $to\nSubject: $SUBJECT\n\n$BODY")
          done